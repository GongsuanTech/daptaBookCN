

<!DOCTYPE html>


<html lang="cn" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3. 链接组件分析 &#8212; dapta 文档</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-KD6ZCS0VXN"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-KD6ZCS0VXN');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Tutorials/Chaining component analyses';</script>
    <link rel="canonical" href="https://daptadocs.com/index.com/Tutorials/Chaining component analyses.html" />
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4. 自动化复材机翼模型参数研究" href="Automating%20parametric%20studies.html" />
    <link rel="prev" title="2. 简单优化问题" href="Simple%20optimisation%20problem.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="cn"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    欢迎大家!
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">教程</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Simple%20component%20analysis.html">1. 简单组件分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Simple%20optimisation%20problem.html">2. 简单优化问题</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">3. 链接组件分析</a></li>
<li class="toctree-l1"><a class="reference internal" href="Automating%20parametric%20studies.html">4. 自动化复材机翼模型参数研究</a></li>
<li class="toctree-l1"><a class="reference internal" href="Automating%20design%20optimisations.html">5. 自动化复材机翼模型优化设计</a></li>
<li class="toctree-l1"><a class="reference internal" href="Working%20with%20spreadsheets.html">6. 使用电子表格仿真</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">参考指南</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Reference/The%20dashboard.html">控制面板</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/FAQs.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/Glossary.html">术语表</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/Support.html">技术支持</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/GongsuanTech/daptaDocsCN" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/GongsuanTech/daptaDocsCN/issues/new?title=Issue%20on%20page%20%2FTutorials/Chaining component analyses.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Tutorials/Chaining component analyses.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>链接组件分析</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">3.1. 创建组件</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.1.1. 参数化模型组件</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculix-fea">3.1.2. Calculix-fea组件</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.1.3. 结果处理组件</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">3.2. 创建连接</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3.2.1. 第一次连接</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.2.2. 更多连接</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3. 执行工作流程</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.4. 检查输出</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">3.5. 清理</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorials-chaining-component-analyses-references">3.6. 参考文献</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="id1">
<h1><span class="section-number">3. </span>链接组件分析<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h1>
<p><a class="reference external" href="https://app.daptaflow.com/tutorial/3"><img alt="dapta" height="25px" src="../_images/Dapta-Brandmark-RGB.svg" width="25px" /> 加载教程到dapta应用程序</a>.
<a class="reference external" href="https://github.com/daptablade/docs/tree/master/mynewbook/Tutorials/parametric_wing_model"><img alt="github" height="25px" src="../_images/github.svg" width="25px" /> 在Github中查看文件</a>.</p>
<p><strong>预计时间：45分钟</strong></p>
<p>在本教程中，我们探讨了<a class="reference internal" href="../Reference/Glossary.html#term-1"><span class="xref std std-term">连接</span></a>的用法：将<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>的执行链接起来。
该示例还介绍了一个关于有限元分析的特定组件API ：<code class="docutils literal notranslate"><span class="pre">calculix-fea-comp</span></code>。</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-1.png"><img alt="chained process" class="bg-primary mb-1 align-center" src="../_images/parametric-model-1.png" style="width: 700px;" /></a>
<section id="id2">
<h2><span class="section-number">3.1. </span>创建组件<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<p>本示例复制了<a class="reference external" href="https://youtube.com/playlist?list=PL3ZV4Vo-Sjze6-DaoPgJcIvU-uAYB7KpZ">参数化机翼模型系列</a>
第1与2部分中介绍的链接分析。我们利用Python和开源软件<a class="reference external" href="http://www.dhondt.de/">CalculiX GraphiX</a>
创建了一个受静态尖端载荷作用的复合材料机翼的参数化有限元模型，
然后使用<a class="reference external" href="http://www.dhondt.de/">CalculiX CrunchiX</a>进行分析。</p>
<p>我们展示了如何将之前的单体Python代码分割成离散的、具有潜在重用价值的<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>。
详细的Python代码在之前的视频和相关博客文章中已经涵盖
（见<a class="reference internal" href="#tutorials-chaining-component-analyses-references"><span class="std std-ref">参考文献1和2</span></a>）。</p>
<p>我们将参数化模型分析过程分为三个不同的<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>，如下图所示。</p>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-2.png"><img alt="chained-process-components" class="bg-primary mb-1 align-center" src="../_images/parametric-model-2.png" style="width: 700px;" /></a>
<section id="id3">
<h3><span class="section-number">3.1.1. </span>参数化模型组件<a class="headerlink" href="#id3" title="Permalink to this heading">#</a></h3>
<p>参数化模型组件使用Python定义参数化三维机翼几何形状。它还会为Calculix GraphiX输出.fdb文件格式的网格生成指令。</p>
<p>该组件的参数包括机翼的展长和弦长，以及通过上传包含 x 和 y 截面坐标的CSV输入文件定义的翼型横截面。</p>
<p>创建组件：</p>
<ul class="simple">
<li><p>在工作区中单击右键，选择<code class="docutils literal notranslate"><span class="pre">添加空节点</span></code>。选择空组件进行编辑。</p></li>
<li><p>在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡中，填写组件名称为<code class="docutils literal notranslate"><span class="pre">parametric-model</span></code>，并选择通用的Python组件API<code class="docutils literal notranslate"><span class="pre">generic-python3-comp:latest</span></code>。</p></li>
<li><p>将下面的<code class="docutils literal notranslate"><span class="pre">setup.py</span></code>、<code class="docutils literal notranslate"><span class="pre">compute.py</span></code>、<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>和<code class="docutils literal notranslate"><span class="pre">naca0012.csv</span></code>文件内容复制到文本编辑器中，并在本地保存。
然后在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡下上传前三个文件，在<code class="docutils literal notranslate"><span class="pre">参数</span></code>选项卡下通过选择<code class="docutils literal notranslate"><span class="pre">上传用户输入文件</span></code>来上传<code class="docutils literal notranslate"><span class="pre">naca0012.csv</span></code>文件。</p></li>
<li><p>在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡中，勾选<code class="docutils literal notranslate"><span class="pre">开始节点</span></code>选项的复选框。</p></li>
<li><p>将下面的参数JSON对象内容复制到<code class="docutils literal notranslate"><span class="pre">参数</span></code>选项卡的文本框中。</p></li>
<li><p>将以下JSON对象复制到<code class="docutils literal notranslate"><span class="pre">输出</span></code>选项卡的文本框中：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.cgx_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>选择<code class="docutils literal notranslate"><span class="pre">保存数据</span></code>保存并关闭组件。</p></li>
</ul>
<div class="sd-tab-set docutils" id="tutorials-chained-components-parametric-model-files">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A user editable setup function.&quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># set default inputs</span>
    <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">input_value</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">input_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">input_key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">input_key</span><span class="si">}</span><span class="s2"> in the input parameters.&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">message</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">PLOT_FLAG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;airfoil_csv_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;airfoil_csv_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>
    <span class="n">component_inputs</span> <span class="o">=</span> <span class="n">parameters</span>  <span class="c1"># default values</span>
    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">component_inputs</span><span class="p">[</span><span class="n">input_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_value</span>

    <span class="n">geometry</span> <span class="o">=</span> <span class="n">get_geometry</span><span class="p">(</span>
        <span class="n">component_inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">inputs_folder</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="n">PLOT_FLAG</span>
    <span class="p">)</span>
    <span class="n">cgx_fdb_path</span> <span class="o">=</span> <span class="n">get_cgx_input_file</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">component_inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">cgx_fdb_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">name</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Created cgx fdb file </span><span class="si">{</span><span class="n">cgx_fdb_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> with span </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">component_inputs</span><span class="p">[</span><span class="s1">&#39;span&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">m.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_geometry</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">,</span> <span class="n">inputs_folder</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate parameters into geometry description that CGX can understand,</span>
<span class="sd">    that&#39;s points, lines and surfaces.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">aerofoil</span> <span class="o">=</span> <span class="n">_get_aerofoil_from_file</span><span class="p">(</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">inputs_folder</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_csv_file&quot;</span><span class="p">]),</span>
        <span class="n">plot_flag</span><span class="o">=</span><span class="n">plot_flag</span><span class="p">,</span>
        <span class="n">splitpc</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">_get_cgx_points_3d</span><span class="p">(</span>
        <span class="n">aerofoil</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;chord&quot;</span><span class="p">],</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;span&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">lines</span><span class="p">,</span> <span class="n">rib_surfaces</span><span class="p">,</span> <span class="n">aero_surfaces</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">aero_surfaces_flip</span> <span class="o">=</span> <span class="n">_get_cgx_lines_3d</span><span class="p">(</span>
        <span class="n">seqa</span><span class="p">,</span>
        <span class="n">nele_foil</span><span class="o">=</span><span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;nele_foil&quot;</span><span class="p">]),</span>
        <span class="n">nele_span</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;nele_span&quot;</span><span class="p">]),</span>
        <span class="n">split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
        <span class="n">filled_sections</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;aerofoil&quot;</span><span class="p">:</span> <span class="n">aerofoil</span><span class="p">,</span>
        <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
        <span class="s2">&quot;point_seqa&quot;</span><span class="p">:</span> <span class="n">seqa</span><span class="p">,</span>
        <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">lines</span><span class="p">,</span>
        <span class="s2">&quot;surfaces&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ribs&quot;</span><span class="p">:</span> <span class="n">rib_surfaces</span><span class="p">,</span>
            <span class="s2">&quot;aero&quot;</span><span class="p">:</span> <span class="n">aero_surfaces</span><span class="p">,</span>
            <span class="s2">&quot;aero_surfaces_flip&quot;</span><span class="p">:</span> <span class="n">aero_surfaces_flip</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;bodies&quot;</span><span class="p">:</span> <span class="n">bodies</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">get_cgx_input_file</span><span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write CGX batch commands to file.&quot;&quot;&quot;</span>

    <span class="n">fdb_geom_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="s2">&quot;cgx_infile.fdb&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;boundary_conditions&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="n">fix_lines</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;fix_lines&quot;</span><span class="p">])</span>
        <span class="n">loaded_lines</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;loaded_lines&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;loaded_surfaces&quot;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">]:</span>
            <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;boundary_conditions&quot;</span><span class="p">][</span><span class="s2">&quot;loaded_surfaces&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fix_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loaded_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">loaded_surfaces</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># create string of all input commands</span>
    <span class="n">cgx_commands</span> <span class="o">=</span> <span class="n">_get_commands</span><span class="p">(</span>
        <span class="n">geometry</span><span class="p">,</span>
        <span class="n">fix_lines</span><span class="p">,</span>
        <span class="n">loaded_lines</span><span class="p">,</span>
        <span class="n">loaded_surfaces</span><span class="o">=</span><span class="n">loaded_surfaces</span><span class="p">,</span>
        <span class="n">merge_tol</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;node_merge_tol&quot;</span><span class="p">],</span>
        <span class="n">cgx_ele_type</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cgx_ele_type&quot;</span><span class="p">]),</span>
        <span class="n">solver</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;cgx_solver&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># write string of commands to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fdb_geom_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cgx_commands</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fdb_geom_file</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">rint</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="c1"># cover integer values after json import</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_aerofoil_from_file</span><span class="p">(</span>
    <span class="n">file</span><span class="p">,</span> <span class="n">plot_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">splitpc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pt_offset</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads an aerofoil geometry from csv and calculates tc_max.</span>

<span class="sd">    Args:</span>
<span class="sd">        file: file with xy-positions of the airfoil outline in Selig format.</span>
<span class="sd">              For example http://airfoiltools.com/airfoil/seligdatfile?airfoil=n0012-il</span>

<span class="sd">    Returns:</span>
<span class="sd">        airfoil data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># read aerofoil input file</span>
    <span class="n">airfoil</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">airfoil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">airfoil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">airfoil</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># replace the last coordinate to close the airfoil at the trailing-edge</span>
    <span class="n">coordinates</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># we assume that there is a [0.0, 0.0] point in the airfoil</span>
    <span class="n">LE_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">leading_edge_pt</span> <span class="o">=</span> <span class="n">LE_index</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">splitpc</span><span class="p">:</span>
        <span class="c1"># check that there are enough points to split the section</span>
        <span class="n">min_points</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_points</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The parameter &#39;airfoil_cut_chord_percentages&#39; requires &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;at least </span><span class="si">{</span><span class="n">min_points</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> airfoil spline points in &#39;airfoil_csv_file&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># re-order the pc from TE to LE</span>
        <span class="n">splitpc</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># trim points that are within min number of points form leading or trailing edge</span>
        <span class="n">trimmed_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">trimmed_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">pt_offset</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">LE_index</span> <span class="o">-</span> <span class="n">ceil</span><span class="p">(</span><span class="n">pt_offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="p">:],</span>
                <span class="n">trimmed_coords</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">LE_index</span> <span class="o">+</span> <span class="n">ceil</span><span class="p">(</span><span class="n">pt_offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="p">:</span> <span class="o">-</span><span class="n">pt_offset</span><span class="p">,</span> <span class="p">:],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># find two points that match the percentage chord closely</span>
        <span class="k">for</span> <span class="n">split_number</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">splitpc</span><span class="p">):</span>
            <span class="n">point_distances_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">split</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;bot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="n">dist_top</span> <span class="o">=</span> <span class="n">point_distances_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dist_bot</span> <span class="o">=</span> <span class="n">point_distances_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">point_distances_x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_top</span> <span class="ow">and</span> <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">dist_top</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">dist_bot</span> <span class="ow">and</span> <span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">trimmed_coords</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                    <span class="n">dist_bot</span> <span class="o">=</span> <span class="n">dist</span>

            <span class="k">if</span> <span class="n">split_number</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># check number of points separating splits</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;top&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">pt_offset</span>
                    <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pt</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">splits</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">pt_offset</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Values </span><span class="si">{</span><span class="n">splitpc</span><span class="p">[</span><span class="n">split_number</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">split</span><span class="si">:</span><span class="s2">f</span><span class="si">}</span><span class="s2"> in &quot;</span>
                        <span class="s2">&quot;&#39;airfoil_cut_chord_percentages&#39; are too close together.&quot;</span>
                    <span class="p">)</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_flag</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;-xr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">splitpc</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">]],</span>
                    <span class="p">[</span><span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coordinates</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">]],</span>
                    <span class="s2">&quot;-b&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;airfoil_coordinates.png&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">coordinates</span><span class="o">=</span><span class="n">coordinates</span><span class="p">,</span>
        <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">,</span>
        <span class="n">leading_edge_pt</span><span class="o">=</span><span class="n">leading_edge_pt</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_cgx_points_3d</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function generates the CGX input file points and point sequences.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">span</span> <span class="o">=</span> <span class="p">[</span><span class="n">span</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chord</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">chord</span> <span class="o">=</span> <span class="p">[</span><span class="n">chord</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">wing_with_splits</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">):</span>
        <span class="n">seqa</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">starting_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pt_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">split_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">section_index</span><span class="p">,</span> <span class="n">length_y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">span</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">chord</span><span class="p">[</span><span class="n">section_index</span><span class="p">]</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">chord</span><span class="p">[</span><span class="n">section_index</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">section_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only needed at the root of the wing</span>
                <span class="n">y_root</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">starting_y</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y_root</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># section tip</span>
            <span class="n">y_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">starting_y</span> <span class="o">+</span> <span class="n">length_y</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y_tip</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">airfoil_seqa</span><span class="p">(</span><span class="n">pt_counter</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">all_split_points</span><span class="p">,</span> <span class="n">x_size</span><span class="p">):</span>
                <span class="c1"># SEQA for first airfoil top splines</span>
                <span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">split_points</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]:</span>
                    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">])</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span>
                    <span class="n">split_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">])</span>
                <span class="c1"># SEQA for first airfoil LE spline</span>
                <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                        <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]):</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># SEQA for first airfoil bot spline</span>
                    <span class="n">pt</span> <span class="o">=</span> <span class="n">x_size</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">bot_seqa</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]:</span>
                        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">pt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">bot_seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">]</span>
                        <span class="n">split_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="s2">&quot;bot&quot;</span><span class="p">])</span>
                    <span class="n">bot_seqa</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">seqa</span> <span class="o">+=</span> <span class="n">bot_seqa</span>
                    <span class="c1"># all_split_point is nested list of dim 3: aerofoil -&gt; split -&gt; point</span>
                    <span class="n">all_split_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">all_split_points</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;splits&quot;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seqa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">aerofoil</span><span class="p">[</span><span class="s2">&quot;leading_edge_pt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">pt_counter</span> <span class="o">+</span> <span class="n">x_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">all_split_points</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">return</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">all_split_points</span>

            <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">airfoil_seqa</span><span class="p">(</span>
                <span class="n">pt_counter</span><span class="o">=</span><span class="n">pt_counter</span><span class="p">,</span>
                <span class="n">seqa</span><span class="o">=</span><span class="n">seqa</span><span class="p">,</span>
                <span class="n">all_split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
                <span class="n">x_size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">section_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># only needed at the root of the wing</span>
                <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">airfoil_seqa</span><span class="p">(</span>
                    <span class="n">pt_counter</span><span class="o">=</span><span class="n">pt_counter</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                    <span class="n">seqa</span><span class="o">=</span><span class="n">seqa</span><span class="p">,</span>
                    <span class="n">all_split_points</span><span class="o">=</span><span class="n">split_points</span><span class="p">,</span>
                    <span class="n">x_size</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">starting_y</span> <span class="o">+=</span> <span class="n">length_y</span>
            <span class="n">pt_counter</span> <span class="o">=</span> <span class="n">seqa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span>

    <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span> <span class="o">=</span> <span class="n">wing_with_splits</span><span class="p">(</span><span class="n">aerofoil</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">span</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">seqa</span><span class="p">,</span> <span class="n">split_points</span>


<span class="k">def</span> <span class="nf">_get_cgx_lines_3d</span><span class="p">(</span>
    <span class="n">seqa</span><span class="p">,</span>
    <span class="n">nele_foil</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">nele_span</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">nele_split</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">split_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">filled_sections</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function creates the aerofoil section splines and the spanwise bounding lines in CGX.&quot;&quot;&quot;</span>

    <span class="n">nele_multiplier</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># =2 to account for quadratic elements</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aero_surfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">aero_surfaces_flip</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rib_surfaces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nele_span</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">nele_span</span> <span class="o">=</span> <span class="p">[</span><span class="n">nele_span</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nele_foil</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">nele_foil</span> <span class="o">=</span> <span class="p">[</span><span class="n">nele_foil</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filled_sections</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">filled_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">filled_sections</span><span class="p">]</span>

    <span class="n">splits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seqas_per_aerofoil</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">splits</span> <span class="o">=</span> <span class="n">split_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">seqas_per_aerofoil</span> <span class="o">=</span> <span class="n">splits</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">aerofoils</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seqa</span><span class="p">)</span> <span class="o">/</span> <span class="n">seqas_per_aerofoil</span><span class="p">)</span>

    <span class="n">airfoil_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lcounter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">seqa_id</span><span class="p">,</span> <span class="n">seq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">seqa</span><span class="p">):</span>

        <span class="c1"># aerofoil lines</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">seqa_id</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">nele_foil</span><span class="p">[</span><span class="n">seqa_id</span> <span class="o">%</span> <span class="n">seqas_per_aerofoil</span><span class="p">]</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">seqas_per_aerofoil</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">split_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">split_index</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">airfoil_index</span><span class="p">]):</span>

                    <span class="c1"># aerofoil split lines</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">nele_split</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">split_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># prepare rib surfaces definition</span>
                        <span class="n">rib_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span><span class="p">,</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="n">split_index</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">-</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

            <span class="c1"># spanwise lines at trailing edge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">seqas_per_aerofoil</span> <span class="o">&lt;</span> <span class="n">aerofoils</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">te_line_inc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span><span class="p">:</span>
                        <span class="n">start_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">end_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">side</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">pt_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">start_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">end_id</span> <span class="o">=</span> <span class="n">seqa_id</span> <span class="o">+</span> <span class="n">te_line_inc</span>
                        <span class="n">side</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">pt_offset</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">seqa</span><span class="p">[</span><span class="n">start_id</span><span class="p">][</span><span class="n">side</span><span class="p">]</span> <span class="o">+</span> <span class="n">pt_offset</span><span class="p">,</span>
                            <span class="n">seqa</span><span class="p">[</span><span class="n">end_id</span><span class="p">][</span><span class="n">side</span><span class="p">]</span> <span class="o">+</span> <span class="n">pt_offset</span><span class="p">,</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">nele_span</span><span class="p">[</span><span class="n">airfoil_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">nele_multiplier</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">te_line_inc</span> <span class="o">&lt;</span> <span class="n">seqas_per_aerofoil</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># top surface</span>
                            <span class="n">aero_surfaces_flip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># bot surface</span>
                            <span class="n">aero_surfaces_flip</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="c1"># prepare aero surfaces definition</span>
                        <span class="n">aero_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">splits</span> <span class="o">-</span> <span class="n">seqas_per_aerofoil</span><span class="p">,</span>
                                <span class="n">lcounter</span><span class="p">,</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">+</span> <span class="n">seqas_per_aerofoil</span><span class="p">),</span>
                                <span class="o">-</span><span class="p">(</span><span class="n">lcounter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

            <span class="n">airfoil_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># check that ptB_id &gt; ptA_id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;something has gone wrong in the line definition.&quot;</span><span class="p">)</span>

    <span class="c1"># solid bodies</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">surf_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rib_surfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">filled_sections</span><span class="p">[</span><span class="n">surf_id</span><span class="p">]:</span>
            <span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">surf_id</span><span class="p">,</span> <span class="n">surf_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">rib_surfaces</span><span class="p">,</span> <span class="n">aero_surfaces</span><span class="p">,</span> <span class="n">bodies</span><span class="p">,</span> <span class="n">aero_surfaces_flip</span>


<span class="k">def</span> <span class="nf">_get_commands</span><span class="p">(</span>
    <span class="n">geometry</span><span class="p">,</span>
    <span class="n">fix_lines</span><span class="p">,</span>
    <span class="n">loaded_lines</span><span class="p">,</span>
    <span class="n">loaded_surfaces</span><span class="p">,</span>
    <span class="n">merge_tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">cgx_ele_type</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">solver</span><span class="o">=</span><span class="s2">&quot;abq&quot;</span><span class="p">,</span>
    <span class="n">max_entries_per_line</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="nf">divide_chunks</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># looping till length l</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">),</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">l</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># points</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;PNT P</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># point sequences</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">points</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;point_seqa&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SEQA A</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> pnt &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">line_end</span> <span class="o">=</span> <span class="s2">&quot; = </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;P</span><span class="si">{</span><span class="n">point</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">[</span><span class="n">ii</span> <span class="p">:</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]])</span> <span class="o">+</span> <span class="n">line_end</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># lines</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># straight line</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LINE L</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># spline</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;LINE L</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> P</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> A</span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surfaces</span>
    <span class="n">rib_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;ribs&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GSUR V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> + BLEND &quot;</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;+ L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;- L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">surf</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">rib_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>

    <span class="n">aero_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flip_surfaces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">counter</span><span class="p">,</span> <span class="n">surf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero&quot;</span><span class="p">]):</span>
        <span class="n">entity_id</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="p">(</span><span class="n">rib_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">rib_ids</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;GSUR V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> + BLEND &quot;</span>
            <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;+ L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;- L</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">surf</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero_surfaces_flip&quot;</span><span class="p">][</span><span class="n">counter</span><span class="p">]:</span>
            <span class="n">flip_surfaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FLIP V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">aero_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_id</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># bodies</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BODY B</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> V</span><span class="si">{</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> V</span><span class="si">{</span><span class="n">body</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># SPC and load sets</span>
    <span class="k">if</span> <span class="n">fix_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">fix_lines</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA SPC l &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_lines</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">loaded_lines</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA LAST l &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">line</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_surfaces</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">loaded_surfaces</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA TOP s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># surface meshes</span>
    <span class="n">surfaces</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;ribs&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;surfaces&quot;</span><span class="p">][</span><span class="s2">&quot;aero&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">surfaces</span><span class="p">):</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSHP V</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> s </span><span class="si">{</span><span class="n">cgx_ele_type</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> 0 1.000000e+00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="c1"># sets of surfaces</span>
    <span class="k">if</span> <span class="n">rib_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">rib_ids</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA RIBS s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="n">aero_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">divide_chunks</span><span class="p">(</span><span class="n">aero_ids</span><span class="p">,</span> <span class="n">max_entries_per_line</span><span class="p">):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;SETA AERO s &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;V</span><span class="si">{</span><span class="nb">id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># body meshes</span>
    <span class="k">if</span> <span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometry</span><span class="p">[</span><span class="s2">&quot;bodies&quot;</span><span class="p">]):</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MSHP B</span><span class="si">{</span><span class="n">entity_id</span><span class="si">:</span><span class="s2">05d</span><span class="si">}</span><span class="s2"> b 4 0 1.000000e+00</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;# =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># custom export statement</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mesh all</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;merg n all </span><span class="si">{</span><span class="n">merge_tol</span><span class="si">:</span><span class="s2">6f</span><span class="si">}</span><span class="s2"> &#39;nolock&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp nodes d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flip_surfaces</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">+=</span> <span class="n">flip_surfaces</span>
    <span class="k">if</span> <span class="n">fix_lines</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp SPC d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send SPC </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> spc 123456</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_lines</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp LAST d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send LAST </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loaded_surfaces</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp TOP d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send TOP </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rib_ids</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp RIBS d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send RIBS </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">aero_ids</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;comp AERO d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send AERO </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;send all </span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;quit</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>matplotlib==3.7.0
numpy==1.23.5
scipy==1.10.0
</pre></div>
</div>
</div>
<input id="sd-tab-item-3" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
naca0012</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># NACA 0012 from http://airfoiltools.com/
  1.000000  0.001260
  0.999416  0.001342
  0.997666  0.001587
  0.994753  0.001994
  0.990685  0.002560
  0.985471  0.003280
  0.979123  0.004152
  0.971656  0.005169
  0.963087  0.006324
  0.953437  0.007611
  0.942728  0.009022
  0.930985  0.010549
  0.918235  0.012182
  0.904509  0.013914
  0.889837  0.015735
  0.874255  0.017635
  0.857800  0.019605
  0.840508  0.021635
  0.822421  0.023714
  0.803581  0.025834
  0.784032  0.027983
  0.763820  0.030152
  0.742992  0.032329
  0.721596  0.034506
  0.699682  0.036670
  0.677303  0.038811
  0.654509  0.040917
  0.631354  0.042978
  0.607892  0.044980
  0.584179  0.046912
  0.560268  0.048762
  0.536217  0.050516
  0.512082  0.052162
  0.487918  0.053687
  0.463783  0.055077
  0.439732  0.056320
  0.415822  0.057403
  0.392108  0.058314
  0.368646  0.059042
  0.345492  0.059575
  0.322698  0.059903
  0.300318  0.060017
  0.278404  0.059910
  0.257008  0.059576
  0.236180  0.059008
  0.215968  0.058205
  0.196419  0.057164
  0.177579  0.055886
  0.159492  0.054372
  0.142201  0.052625
  0.125745  0.050651
  0.110163  0.048457
  0.095492  0.046049
  0.081765  0.043437
  0.069015  0.040631
  0.057272  0.037641
  0.046563  0.034479
  0.036913  0.031156
  0.028344  0.027683
  0.020877  0.024071
  0.014529  0.020330
  0.009315  0.016471
  0.005247  0.012501
  0.002334  0.008429
  0.000584  0.004260
  0.000000  0.000000
  0.000584 -0.004260
  0.002334 -0.008429
  0.005247 -0.012501
  0.009315 -0.016471
  0.014529 -0.020330
  0.020877 -0.024071
  0.028344 -0.027683
  0.036913 -0.031156
  0.046563 -0.034479
  0.057272 -0.037641
  0.069015 -0.040631
  0.081765 -0.043437
  0.095492 -0.046049
  0.110163 -0.048457
  0.125745 -0.050651
  0.142201 -0.052625
  0.159492 -0.054372
  0.177579 -0.055886
  0.196419 -0.057164
  0.215968 -0.058205
  0.236180 -0.059008
  0.257008 -0.059576
  0.278404 -0.059910
  0.300318 -0.060017
  0.322698 -0.059903
  0.345492 -0.059575
  0.368646 -0.059042
  0.392108 -0.058314
  0.415822 -0.057403
  0.439732 -0.056320
  0.463783 -0.055077
  0.487918 -0.053687
  0.512082 -0.052162
  0.536217 -0.050516
  0.560268 -0.048762
  0.584179 -0.046912
  0.607892 -0.044980
  0.631354 -0.042978
  0.654509 -0.040917
  0.677303 -0.038811
  0.699682 -0.036670
  0.721596 -0.034506
  0.742992 -0.032329
  0.763820 -0.030152
  0.784032 -0.027983
  0.803581 -0.025834
  0.822421 -0.023714
  0.840508 -0.021635
  0.857800 -0.019605
  0.874255 -0.017635
  0.889837 -0.015735
  0.904509 -0.013914
  0.918235 -0.012182
  0.930985 -0.010549
  0.942728 -0.009022
  0.953437 -0.007611
  0.963087 -0.006324
  0.971656 -0.005169
  0.979123 -0.004152
  0.985471 -0.003280
  0.990685 -0.002560
  0.994753 -0.001994
  0.997666 -0.001587
  0.999416 -0.001342
  1.000000 -0.001260
</pre></div>
</div>
</div>
<input id="sd-tab-item-4" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
parameters</label><div class="sd-tab-content docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;span&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;chord&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;filled_sections_flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;airfoil_csv_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;naca0012.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;nele_foil&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="mi">10</span><span class="p">,</span>
<span class="w">        </span><span class="mi">10</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;nele_span&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;node_merge_tol&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.002</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cgx_ele_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cgx_solver&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abq&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;boundary_conditions&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;fix_lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="mi">1</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;loaded_lines&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="mi">5</span><span class="p">,</span>
<span class="w">            </span><span class="mi">6</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="calculix-fea">
<h3><span class="section-number">3.1.2. </span>Calculix-fea组件<a class="headerlink" href="#calculix-fea" title="Permalink to this heading">#</a></h3>
<p>该组件首先在参数化模型组件的.fdb文件上批处理执行CalculiX GraphiX，生成有限元模型网格文件（all.msh）。
然后，使用Python生成复合材料壳体截面属性并写入文件（composite_shell.inp），
再使用CalculiX CrunchiX执行模型的有限元分析（FEA）。</p>
<p>该组件的输出：机翼尖部的网格节点挠度（FEA输出文件【ccx_static_tip_shear.dat】），
以及模型网格文件和节点集定义文件，都将被用于下一个组件中的有限元分析结果后处理。</p>
<p>在这里，我们使用一个特定于应用的组件API称为【calculix-fea-comp】，它确保Calculix被安装在本地计算环境。
它还允许我们通过从计算函数中的<code class="docutils literal notranslate"><span class="pre">calculix</span></code>模块导入<code class="docutils literal notranslate"><span class="pre">execute_cgx</span></code>和<code class="docutils literal notranslate"><span class="pre">execute_fea</span></code>方法从Python中执行CalculiX。
在所有其他方面，该API与通用Python组件API<code class="docutils literal notranslate"><span class="pre">generic-python3-comp</span></code>相同。</p>
<p>创建组件：</p>
<ul class="simple">
<li><p>在工作区中单击右键并选择<code class="docutils literal notranslate"><span class="pre">添加空节点</span></code>。选择空组件并编辑。</p></li>
<li><p>在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡中填写组件名称为<code class="docutils literal notranslate"><span class="pre">calculix-fea</span></code>，并选择组件API<code class="docutils literal notranslate"><span class="pre">calculix-fea-comp:latest</span></code>。</p></li>
<li><p>将下面的<code class="docutils literal notranslate"><span class="pre">setup.py</span></code>、<code class="docutils literal notranslate"><span class="pre">compute.py</span></code>、<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>和<code class="docutils literal notranslate"><span class="pre">ccx_static_tip_shear.inp</span></code>文件的内容复制到文本编辑器中，
并在本地保存。然后在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡下上传前3个文件，在<code class="docutils literal notranslate"><span class="pre">参数</span></code>选项卡下通过选择<code class="docutils literal notranslate"><span class="pre">上传用户输入文件</span></code>上传最后一个文件。</p></li>
<li><p>将下面的参数JSON对象的内容复制到<code class="docutils literal notranslate"><span class="pre">参数</span></code>选项卡文本框中。</p></li>
<li><p>将以下JSON对象复制到<code class="docutils literal notranslate"><span class="pre">输入</span></code>选项卡文本框中：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.cgx_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fibre_rotation_angle.ORI_0.1&quot;</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>将以下JSON对象复制到<code class="docutils literal notranslate"><span class="pre">输出</span></code>选项卡文本框中：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.mesh_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>选择<code class="docutils literal notranslate"><span class="pre">保存数据</span></code>以保存并关闭组件。</p></li>
</ul>
<div class="sd-tab-set docutils" id="tutorials-chained-components-calculix-fea-files">
<input checked="checked" id="sd-tab-item-5" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-5">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="c1"># declare default parameter inputs - overriden by connection data if available</span>
    <span class="k">if</span> <span class="s2">&quot;files.cgx_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">fibre_rotation_angles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fibre_rotation_angle&quot;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">fibre_rotation_angles</span><span class="p">:</span>
        <span class="c1"># set to float</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">])</span>

    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">inputs</span><span class="p">}</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-6" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-6">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy2</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>

<span class="kn">from</span> <span class="nn">calculix</span> <span class="kn">import</span> <span class="n">execute_cgx</span><span class="p">,</span> <span class="n">execute_fea</span>

<span class="n">PLOT_FLAG</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;implicit&#39;</span><span class="p">][</span><span class="s1">&#39;files.cgx_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> param file connection needed from parametric-model component.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;analysis_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> needs to be uploaded by the user.&quot;</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>

    <span class="n">run_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">])</span>
    <span class="c1"># Generate the ccx input mesh with cgx</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">copy2</span><span class="p">(</span>
        <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.cgx_file&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_cgx</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;cgx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;cgx returned non-zero exit status </span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="n">mesh_file_path</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mesh_file_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">mesh_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CCX analysis mesh file with CGX.&quot;</span><span class="p">)</span>

    <span class="c1"># define composite material properties</span>
    <span class="k">if</span> <span class="s2">&quot;composite_layup&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>

        <span class="n">fibre_rotation_angles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;fibre_rotation_angle&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">fibre_rotation_angles</span><span class="p">:</span>
            <span class="c1"># rotate a fibre direction in the orientations parameter</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">angle</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ori_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">id</span> <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">_rotate_vector</span><span class="p">(</span>
                <span class="n">angle</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">angle</span><span class="p">]),</span>
                <span class="n">starting</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Orientation </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> direction </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2"> set to </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;orientations&#39;</span><span class="p">][</span><span class="n">ori_index</span><span class="p">][</span><span class="n">direction</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">get_composite_properties_input</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created CCX composite properties file.&quot;</span><span class="p">)</span>

    <span class="c1"># run the FEM model analysis</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">copy2</span><span class="p">(</span>
        <span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
        <span class="n">run_folder</span> <span class="o">/</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;analysis_file&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">execute_fea</span><span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="n">run_folder</span><span class="o">=</span><span class="n">run_folder</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="s2">&quot;ccx.log&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;stdout&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ChildProcessError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;ccx returned non-zero exit status </span><span class="si">{</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;returncode&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

    <span class="c1"># check output has been saved</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">run_folder</span> <span class="o">/</span> <span class="p">(</span><span class="n">infile</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">outfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executed CCX FEM analysis.&quot;</span><span class="p">)</span>

    <span class="c1"># set outputs</span>
    <span class="c1"># outputs = {&quot;output_files&quot;: [outfile.name]}</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Executed Calculix finite element analysis.&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">name</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all.msh&quot;</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;LAST.nam&quot;</span>

    <span class="c1"># increase dummy variable to ensure the next component executes</span>
    <span class="k">if</span> <span class="s2">&quot;output_1&quot;</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]:</span>
        <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="s2">&quot;output_1&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_composite_properties_input</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">run_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;write an FEA input file with the composite properties.&quot;&quot;&quot;</span>

    <span class="c1"># check and update the element type in the mesh input file</span>
    <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8,&quot;</span>
    <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R,&quot;</span>
    <span class="n">_file_find_replace</span><span class="p">(</span>
        <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
        <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
        <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;filled_sections_flags&quot;</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">],</span> <span class="nb">list</span>
    <span class="p">):</span>
        <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]]</span>

    <span class="n">shell_set_name</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;shell_set_name&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;filled_sections_flags&quot;</span> <span class="ow">in</span> <span class="n">inputs</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;filled_sections_flags&quot;</span><span class="p">]):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;airfoil_cut_chord_percentages&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;if &#39;filled_sections_flags&#39; is switched on, &#39;airfoil_cut_chord_percentages&#39;&quot;</span>
                <span class="s2">&quot;should be a list of length 2.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># create separate element sets for shells and solids</span>
        <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R, ELSET=Eall&quot;</span>
        <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=S8R, ELSET=SURF&quot;</span>
        <span class="n">_file_find_replace</span><span class="p">(</span>
            <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
            <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
            <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">str_find</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=C3D20, ELSET=Eall&quot;</span>
        <span class="n">str_replace</span> <span class="o">=</span> <span class="s2">&quot;*ELEMENT, TYPE=C3D20, ELSET=CORE&quot;</span>
        <span class="n">_file_find_replace</span><span class="p">(</span>
            <span class="n">file</span><span class="o">=</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;mesh_file&quot;</span><span class="p">]),</span>
            <span class="n">find</span><span class="o">=</span><span class="n">str_find</span><span class="p">,</span>
            <span class="n">replace_with</span><span class="o">=</span><span class="n">str_replace</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># get input file cards for this solver</span>
    <span class="n">ccx_commands</span> <span class="o">=</span> <span class="n">_get_ccx_composite_shell_props</span><span class="p">(</span>
        <span class="n">plies</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_plies&quot;</span><span class="p">],</span>
        <span class="n">orientations</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">],</span>
        <span class="n">layup</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_layup&quot;</span><span class="p">],</span>
        <span class="n">shell_set_name</span><span class="o">=</span><span class="n">shell_set_name</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># write string of commands to file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_folder</span> <span class="o">/</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;composite_props_file&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ccx_commands</span><span class="p">))</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">_file_find_replace</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">find</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">find</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">contents</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">find</span><span class="p">,</span> <span class="n">replace_with</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Find &amp; Replace edited file &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39; at line </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contents</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_ccx_composite_shell_props</span><span class="p">(</span>
    <span class="n">plies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orientations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell_set_name</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">shell_set_name</span><span class="p">:</span>
        <span class="n">shell_set_name</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ribs&quot;</span><span class="p">:</span> <span class="s2">&quot;ERIBS&quot;</span><span class="p">,</span> <span class="s2">&quot;aero&quot;</span><span class="p">:</span> <span class="s2">&quot;EAERO&quot;</span><span class="p">}</span>

    <span class="c1"># orientation cards</span>
    <span class="k">for</span> <span class="n">ori</span> <span class="ow">in</span> <span class="n">orientations</span><span class="p">:</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*ORIENTATION,NAME=</span><span class="si">{</span><span class="n">ori</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">],</span> <span class="o">*</span><span class="n">ori</span><span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">]])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;** =============== </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># shell property</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">section_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">shell_set_name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*SHELL SECTION,ELSET=</span><span class="si">{</span><span class="n">section_name</span><span class="si">}</span><span class="s2">,COMPOSITE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ply</span> <span class="ow">in</span> <span class="n">layup</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plies</span> <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ply</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;thickness&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6f</span><span class="si">}</span><span class="s2">,,</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;material&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">props</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">commands</span>


<span class="k">def</span> <span class="nf">_rotate_vector</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">starting</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotate a vector about an axis by an angle in degrees.&quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_rotvec</span><span class="p">(</span><span class="n">angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axis</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">starting</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-7" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-7">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>matplotlib==3.7.0
numpy==1.23.5
scipy==1.10.0
</pre></div>
</div>
</div>
<input id="sd-tab-item-8" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-8">
ccx_static_tip_shear</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>*HEADING
Model: Cantilevered composite box with tip shear
**********************
** NODES AND ELEMENTS
*INCLUDE,INPUT=all.msh
**********************
** COMPOSITE PROPERTIES
*MATERIAL,NAME=EL
*ELASTIC, TYPE =ENGINEERING CONSTANTS
128.0E9,11.0E9,11.0E9,0.28,0.3,0.3,4.5E9,4.5E9,
4.5E9,20.0
*DENSITY
1520.0
*INCLUDE,INPUT=composite_shell.inp
**********************
** BOUNDARY CONDITIONS AND LOAD SET
*BOUNDARY
*INCLUDE,INPUT=SPC_123456.bou
*INCLUDE,INPUT=LAST.nam
**********************
*STEP
*STATIC
*CLOAD
NLAST,3,1.0
*NODE FILE 
U
*NODE PRINT,NSET=NLAST
U
*END STEP
</pre></div>
</div>
</div>
<input id="sd-tab-item-9" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-9">
parameters</label><div class="sd-tab-content docutils">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;analysis_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ccx_static_tip_shear.inp&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;mesh_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;all.msh&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;filled_sections_flags&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;shell_set_name&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;aero&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Eall&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;composite_plies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;thickness&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0002</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EL&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;orientation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_0&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;thickness&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0002</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;material&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EL&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;orientation&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_90&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;orientations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="mf">-1.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ORI_90&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">        </span><span class="mf">0.0</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;composite_layup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;aero&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;p_90&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;composite_props_file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;composite_shell.inp&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3><span class="section-number">3.1.3. </span>结果处理组件<a class="headerlink" href="#id4" title="Permalink to this heading">#</a></h3>
<p>执行链中的最后一个组件读取有限元分析输出，并计算机翼尖端网格节点处的挠度和扭转。
该数据作为一个包括六个条目的Python字典输出：全局x、y和z中的三个挠度（“U”）以及绕x、y、z旋转的三个转角（“R”）。</p>
<p>创建组件：</p>
<ul class="simple">
<li><p>在工作区中单击右键并选择<code class="docutils literal notranslate"><span class="pre">添加空节点</span></code>。选择空组件并进行编辑。</p></li>
<li><p>在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡中，填写组件名称<code class="docutils literal notranslate"><span class="pre">fea-results-processor</span></code>，并选择组件API<code class="docutils literal notranslate"><span class="pre">generic-python3-comp:latest</span></code>。</p></li>
<li><p>从下面的内容中复制<code class="docutils literal notranslate"><span class="pre">setup.py</span></code>、<code class="docutils literal notranslate"><span class="pre">compute.py</span></code>、<code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>文件的内容到文本编辑器中，并在本地保存。
然后在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡下上传它们。</p></li>
<li><p>在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡中勾选<code class="docutils literal notranslate"><span class="pre">结束节点</span></code>选项复选框。</p></li>
<li><p>将以下JSON对象复制到<code class="docutils literal notranslate"><span class="pre">输入</span></code>选项卡文本框中：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.mesh_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
  <span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>将以下JSON对象复制到<code class="docutils literal notranslate"><span class="pre">输出</span></code>选项卡文本框中：</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;Ux&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Uy&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Uz&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rx&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ry&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rz&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>选择<code class="docutils literal notranslate"><span class="pre">保存数据</span></code>以保存编辑并关闭组件界面。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>现在请记得通过选择界面控件<code class="docutils literal notranslate"><span class="pre">下载</span></code>来保存会话数据。</p>
</div>
<div class="sd-tab-set docutils" id="tutorials-chained-components-results-processor-files">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-10">
setup</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Editable setup function.&quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># set default inputs</span>
    <span class="k">if</span> <span class="n">inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">input_key</span><span class="p">,</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">input_value</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">input_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">input_key</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">input_key</span><span class="si">}</span><span class="s2"> in the input parameters.&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>

    <span class="c1"># initialise outputs - required for OpenMDAO</span>
    <span class="k">if</span> <span class="n">outputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output_key</span><span class="p">,</span> <span class="n">output_value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">output_value</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">][</span><span class="n">output_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">output_key</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> in the input parameters.&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span>

    <span class="c1"># declare default parameter inputs - overriden by connection data if available</span>
    <span class="k">if</span> <span class="s2">&quot;files.analysis_output_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;files.analysis_output_file&quot;</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;files.mesh_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;files.mesh_file&quot;</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;files.nodeset_file&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span>
            <span class="s2">&quot;files.nodeset_file&quot;</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;inputs&quot;</span><span class="p">][</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

    <span class="n">response</span><span class="p">[</span>
        <span class="s2">&quot;message&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Setup completed.&quot;</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-11" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-11">
compute</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">outputs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;design&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;implicit&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="p">{}},</span>
    <span class="n">partials</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;user_input_files&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;outputs_folder_path&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Editable compute function.&quot;&quot;&quot;</span>

    <span class="n">datfile</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.analysis_output_file&quot;</span><span class="p">]</span>
    <span class="n">mesh_file</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.mesh_file&quot;</span><span class="p">]</span>
    <span class="n">node_set_file</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;implicit&quot;</span><span class="p">][</span><span class="s2">&quot;files.nodeset_file&quot;</span><span class="p">]</span>

    <span class="c1"># check input files have been uploaded</span>
    <span class="n">inputs_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;inputs_folder_path&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">datfile</span><span class="p">,</span> <span class="n">mesh_file</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inputs_folder</span> <span class="o">/</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> param file connection needed from calculix-fea component.&quot;</span>
            <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting user function evaluation.&quot;</span><span class="p">)</span>

    <span class="c1"># recover the analysis results</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_fea_outputs</span><span class="p">(</span>
        <span class="n">datfile</span><span class="o">=</span><span class="n">datfile</span><span class="p">,</span>
        <span class="n">mesh_file</span><span class="o">=</span><span class="n">mesh_file</span><span class="p">,</span>
        <span class="n">node_set_file</span><span class="o">=</span><span class="n">node_set_file</span><span class="p">,</span>
        <span class="n">folder</span><span class="o">=</span><span class="n">inputs_folder</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: Completed fea output processing: </span><span class="se">\n</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_fea_outputs</span><span class="p">(</span><span class="n">datfile</span><span class="p">,</span> <span class="n">mesh_file</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recover the analysis outputs and process them for plotting.&quot;&quot;&quot;</span>

    <span class="c1"># read file and recover node displacements</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="n">datfile</span>
    <span class="c1"># all_disp : [nodeid, vx, vy, vz]</span>
    <span class="n">all_disps</span> <span class="o">=</span> <span class="n">_get_from_dat</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;displacements&quot;</span><span class="p">)</span>

    <span class="c1"># get node ids for displacement output &gt; read from LAST.nam file</span>
    <span class="n">node_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">_get_from_inp</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">node_set_file</span><span class="p">),</span> <span class="n">keyword</span><span class="o">=</span><span class="s2">&quot;NSET,NSET=&quot;</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># filter all_disp by node ids</span>
    <span class="n">disp_filter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">all_disps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">node_ids</span><span class="p">)</span>
    <span class="n">tip_disps</span> <span class="o">=</span> <span class="n">all_disps</span><span class="p">[</span><span class="n">disp_filter</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># average the deflections</span>
    <span class="n">v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">disp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">v_mean</span><span class="p">[</span><span class="n">disp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">tip_disps</span><span class="p">[:,</span> <span class="n">disp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculate the average rotations</span>
    <span class="n">rotations_mean</span> <span class="o">=</span> <span class="n">_get_average_rotation</span><span class="p">(</span>
        <span class="n">all_disps</span><span class="o">=</span><span class="n">tip_disps</span><span class="p">,</span> <span class="n">mesh_file</span><span class="o">=</span><span class="n">folder</span> <span class="o">/</span> <span class="n">mesh_file</span>
    <span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Ux&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;Uy&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;Uz&quot;</span><span class="p">:</span> <span class="n">v_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s2">&quot;Rx&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="s2">&quot;Ry&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="s2">&quot;Rz&quot;</span><span class="p">:</span> <span class="n">rotations_mean</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">outputs</span>


<span class="c1">########### Private functions that do not get called directly</span>


<span class="k">def</span> <span class="nf">_get_from_dat</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># extract data assuming this is the only output</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data_values</span> <span class="o">=</span> <span class="n">contents</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:]</span>
            <span class="k">break</span>

    <span class="c1"># parse data</span>
    <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s2">&quot;displacements&quot;</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data_values</span>
                <span class="k">if</span> <span class="n">line</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">_get_from_inp</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">keyword</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># extract data</span>
    <span class="n">read_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">read_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">read_flag</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_get_average_rotation</span><span class="p">(</span>
    <span class="n">all_disps</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mesh_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">axes</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">),</span>  <span class="c1"># basic x, y, z axes</span>
<span class="p">):</span>
    <span class="c1"># for each output node, recover the node undeformed mesh position</span>
    <span class="c1"># node_positions : [nodeid, x, y, z]</span>
    <span class="n">node_positions</span> <span class="o">=</span> <span class="n">_get_nodes_from_inp</span><span class="p">(</span><span class="n">mesh_file</span><span class="p">,</span> <span class="n">ref_nodes</span><span class="o">=</span><span class="n">all_disps</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">origin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">node_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># LE</span>
    <span class="c1"># calculate the approximate rotation from each node</span>
    <span class="n">rotations</span> <span class="o">=</span> <span class="n">_get_rot_from_disp</span><span class="p">(</span><span class="n">all_disps</span><span class="p">,</span> <span class="n">node_positions</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">origin_index</span><span class="p">)</span>

    <span class="c1"># average the rotation values</span>
    <span class="n">rotations_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">rot</span> <span class="ow">in</span> <span class="n">rotations</span><span class="p">:</span>
        <span class="n">rotations_mean</span><span class="p">[</span><span class="n">rot</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">rotations</span><span class="p">[</span><span class="n">rot</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">rotations_mean</span>


<span class="k">def</span> <span class="nf">_get_nodes_from_inp</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ref_nodes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="c1"># find node definitions in the file</span>
    <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contents</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;*NODE&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">and</span> <span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># marks the next keyword</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="c1"># parse to array</span>
    <span class="n">nodes_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">line</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># filter reference nodes</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ref_nodes</span><span class="p">):</span>
        <span class="n">nodes_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">nodes_vals</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref_nodes</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">nodes_vals</span>


<span class="k">def</span> <span class="nf">_get_rot_from_disp</span><span class="p">(</span><span class="n">all_disps</span><span class="p">,</span> <span class="n">node_positions</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">origin_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an array of rotations in radians. Using small deflection assumptions.&quot;&quot;&quot;</span>

    <span class="n">all_rots</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">))}</span>
    <span class="n">origin_displacements</span> <span class="o">=</span> <span class="n">all_disps</span><span class="p">[</span><span class="n">origin_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">origin_location</span> <span class="o">=</span> <span class="n">node_positions</span><span class="p">[</span><span class="n">origin_index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># loop throught the nodes and y rotation axes</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_positions</span><span class="p">):</span>
        <span class="c1"># vector from origin to node position</span>
        <span class="n">v_op</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">origin_location</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_op</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># skip the origin</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
                <span class="c1"># calculate local rotation unit vector</span>
                <span class="n">v_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">v_op</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">v_r</span> <span class="o">=</span> <span class="n">v_r</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_r</span><span class="p">)</span>
                    <span class="n">d_vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_r</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>  <span class="c1"># this should already be a unit vector</span>
                    <span class="n">dist_from_axis</span> <span class="o">=</span> <span class="n">v_op</span> <span class="o">@</span> <span class="n">d_vect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">d_vect</span><span class="p">)</span>
                    <span class="c1"># calculate local rotation at the centroid</span>
                    <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">all_disps</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">origin_displacements</span><span class="p">)</span> <span class="o">@</span> <span class="n">v_r</span><span class="p">)</span>
                        <span class="o">/</span> <span class="n">dist_from_axis</span>
                    <span class="p">)</span>
                    <span class="n">all_rots</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skip point [</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">] on the local rotation axis </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">all_rots</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-12" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-12">
requirements</label><div class="sd-tab-content docutils">
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>numpy==1.23.5
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id5">
<h2><span class="section-number">3.2. </span>创建连接<a class="headerlink" href="#id5" title="Permalink to this heading">#</a></h2>
<p>我们现在可以连接我们创建的各个<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>，以确保预期的输入和输出在它们之间有效传递。<a class="reference internal" href="../Reference/Glossary.html#term-1"><span class="xref std std-term">连接</span></a>被定义为从<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>输出句柄到另一个<a class="reference internal" href="../Reference/Glossary.html#term-0"><span class="xref std std-term">组件</span></a>输入句柄的数据链接。</p>
<section id="id6">
<h3><span class="section-number">3.2.1. </span>第一次连接<a class="headerlink" href="#id6" title="Permalink to this heading">#</a></h3>
<p>通过选择参数化模型组件的输出句柄并将线条拖动到calculix-fea组件的【files.cgx_file】输入句柄，创建第一个连接。将鼠标悬停在句柄上，可以看到相关输入或输出数据的名称出现在组件下面。</p>
<p>默认情况下，一个新连接是【设计变量】类型连接（黑色线），不能用于传输文件（有关详细信息，请参见仪表板参考部分）。</p>
<p>在工作区中选择<a class="reference internal" href="../Reference/Glossary.html#term-1"><span class="xref std std-term">连接</span></a>并编辑它。在<code class="docutils literal notranslate"><span class="pre">属性</span></code>选项卡下，通过选择相应的单选按钮，
将<a class="reference internal" href="../Reference/Glossary.html#term-1"><span class="xref std std-term">连接</span></a>类型选项从默认的【设计变量】更改为【隐式变量或文件】。</p>
<p>选择<code class="docutils literal notranslate"><span class="pre">保存数据</span></code>以保存更改并关闭连接界面。检查连接线颜色是否变为绿色，这表示一种【隐式】类型的数据连接。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>默认情况下，连接标签设置为相关输出句柄数据的名称。实际上，没有要求输入和输出数据名称必须匹配。
因此，如果我们不小心的话，很容易连接错误！</p>
</div>
</section>
<section id="id7">
<h3><span class="section-number">3.2.2. </span>更多连接<a class="headerlink" href="#id7" title="Permalink to this heading">#</a></h3>
<p>以相同的方式，在计算calculix-fea组件和fea-results-processor组件之间创建3个连接，将具有匹配数据名称的句柄链接起来。</p>
<p>编辑所有3个连接，将它们修改为【隐式】类型数据连接，因为我们传输文件而不是设计变量。</p>
<p>检查所有3个组件旁边是否出现绿色勾号，以指示它们是有效的。</p>
<p>现在通过从界面控件中选择<code class="docutils literal notranslate"><span class="pre">下载</span></code>来保存会话数据。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>四个连接对象应该出现在会话数据文件的'connections'键下。</p>
</div>
</section>
</section>
<section id="id8">
<h2><span class="section-number">3.3. </span>执行工作流程<a class="headerlink" href="#id8" title="Permalink to this heading">#</a></h2>
<p>现在，我们可以通过选择<a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>控制界面中的运行符号 ▶ 来执行链接组件的分析运行。</p>
<p>一旦运行开始，每个组件将会被设置然后依次执行。设置顺序是任意的，
但是计算函数总是会从【起始节点】到【结束节点】执行（有关详细信息，请参见控制面板参考部分）。</p>
<p>一旦fea-results-component计算完成后，<a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>应该就完成了。</p>
</section>
<section id="id9">
<h2><span class="section-number">3.4. </span>检查输出<a class="headerlink" href="#id9" title="Permalink to this heading">#</a></h2>
<p><a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>日志总结了组件的输出。通过选择界面控件中的<code class="docutils literal notranslate"><span class="pre">查看日志</span></code>来打开日志。</p>
<p>向下滚动到【run_output】部分，可以看到它包含了所有三个组件按照执行顺序排列的计算函数输出信息，
如下图所示。最后一条信息包含了预期的翼尖挠度和转角数据。</p>
<p>也需要检查所有3个组件的<code class="docutils literal notranslate"><span class="pre">日志</span></code>选项卡，并下载文件快照以查看所有组件的输入、连接和输出文件。</p>
<p>现在，通过选择界面控件中的<code class="docutils literal notranslate"><span class="pre">下载</span></code>来保存会话数据和<a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>日志。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>【文件快照】zip文件夹中出现的【连接】文件夹包含任何传入的连接文件。
这是为了将它们与用户文件存储系统中的参数化和API输入文件区分开来，其中这些文件存在于指向上游组件文件的符号链接中，
以提高效率。然而，在计算函数开始之前，连接文件会被复制到<code class="docutils literal notranslate"><span class="pre">parameters[&quot;inputs_folder_path&quot;]</span></code>中。</p>
</div>
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/parametric-model-3.png"><img alt="run log" class="bg-primary mb-1 align-center" src="../_images/parametric-model-3.png" style="width: 700px;" /></a>
</section>
<section id="id10">
<h2><span class="section-number">3.5. </span>清理<a class="headerlink" href="#id10" title="Permalink to this heading">#</a></h2>
<p>通过选择界面中的<code class="docutils literal notranslate"><span class="pre">创建</span></code>来删除您的会话，可能需要一分钟左右在云端重置会话。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>当您即将删除一个<a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>时，您应该会看到一个警告消息。如果您选择继续，则所有的<a class="reference internal" href="../Reference/Glossary.html#term-2"><span class="xref std std-term">运行</span></a>数据（会话数据、输入和输出）将被永久删除。</p>
</div>
</section>
<section id="tutorials-chaining-component-analyses-references">
<span id="id11"></span><h2><span class="section-number">3.6. </span>参考文献<a class="headerlink" href="#tutorials-chaining-component-analyses-references" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://www.dapta.com/parametric-fem-model-creation-with-python-and-calculix-graphix-cgx/">Parametric FEM model creation with Python and CalculiX GraphiX (cgx)</a></p></li>
<li><p><a class="reference external" href="https://www.dapta.com/automated-fem-analysis-and-output-processing-with-python-and-calculix-crunchix-ccx/">Automated FEM analysis and output processing with Python and CalculiX CrunchiX (ccx)</a></p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Tutorials"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Simple%20optimisation%20problem.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">2. </span>简单优化问题</p>
      </div>
    </a>
    <a class="right-next"
       href="Automating%20parametric%20studies.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">4. </span>自动化复材机翼模型参数研究</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">3.1. 创建组件</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">3.1.1. 参数化模型组件</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculix-fea">3.1.2. Calculix-fea组件</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">3.1.3. 结果处理组件</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">3.2. 创建连接</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">3.2.1. 第一次连接</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">3.2.2. 更多连接</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">3.3. 执行工作流程</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">3.4. 检查输出</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">3.5. 清理</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tutorials-chaining-component-analyses-references">3.6. 参考文献</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dapta Ltd & 工算科技
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>